version: 2
jobs:
  test-client:
    docker:
      - image: circleci/node:10.15.0
      - image: selenium/standalone-chrome
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "client/package.json" }}
      - run:
          name: npm ci
          command: cd client && npm ci
      - save_cache:
          key: dependency-cache-{{ checksum "client/package.json" }}
          paths:
            - client/node_modules
      - run:
          name: Linting
          command: cd client && npm run lint
      - run:
          name: unit tests
          command: cd client && npm run test
      - run:
          name: e2e tests
          command: cd client && npm run e2e -- --configuration=serve

  test-server:
    docker:
      - image: circleci/node:10.15.0
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "server/package.json" }}
      - run:
          name: Install npm
          command: cd server && npm install
      - save_cache:
          key: dependency-cache-{{ checksum "server/package.json" }}
          paths:
            - client/node_modules
      - run:
          name: Run tests
          command: cd server && npm run test

  deploy-develop:
    machine:
      enabled: true
    environment:
      SERVER: "198.211.119.171"
    steps:
      - run: ssh-keyscan $SERVER >> ~/.ssh/known_hosts
      - add_ssh_keys:
          fingerprints:
            - "bf:4d:de:df:60:0e:c7:aa:95:4d:3d:98:d2:d6:e8:49"
      - run:
          name: Deploy to development server
          command: |
            ssh shd@$SERVER "NODE_ENV=development" bash -c '
            cd /var/www/rare_app_nodejs
            git checkout .
            git checkout development
            git pull
            docker-compose down
            NODE_ENV=development docker-compose -f docker-compose.yml -f docker-compose.ci.yml up --build -d'

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - test-client
      - deploy-develop:
          requires:
            - test-client
          filters:
            branches:
              only: development
